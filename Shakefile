cage:
	go build -o cage
build:
	docker build -t canarycage .
test: build
	docker run -t canarycage shake do-test
do-test:
	go test -coverprofile=coverage.txt -covermode=count
	if [ ${CI} ];then
		bash <(curl -s https://codecov.io/bash)
	fi
in: build
	docker run -v `pwd`:/go/src/github.com/loilo-inc/canarycage -t canarycage /bin/bash
test-container:
	docker build -t canarycage/test-container test-container
push-test-container: test-container
	docker tag canarycage/test-container loilodev/http-server:latest
	docker push loilodev/http-server:latest
.deploy:
	DEPLOY_DIR=`pwd`/.deploy
	mkdir -p ${DEPLOY_DIR}
terraform:
	cd terraform
	if [ ! -e terraform/.terraform ];then
		terraform init
	fi
	terraform apply
	cd ../
.deploy/service.json: .deploy terraform
	OUT=`pwd`/.deploy/service.json
	cd terraform
	terraform output service.json > ${OUT}
	cd ../
.deploy/task-definition.json: .deploy terraform
	OUT=`pwd`/.deploy/task-definition.json
	cd terraform
	terraform output task-definition.json > ${OUT}
	cd ../